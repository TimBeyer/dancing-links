name: Benchmark

on:
  pull_request:
    branches: [ main, master ]

jobs:
  benchmark:
    runs-on: namespace-profile-default
    # Only run PR comparison for pull requests
    if: github.event_name == 'pull_request'

    strategy:
      matrix:
        runtime: [node-22, node-24, node-25, bun-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to find merge-base

    - name: Parse runtime version
      id: version
      run: echo "value=${RUNTIME#*-}" >> $GITHUB_OUTPUT
      env:
        RUNTIME: ${{ matrix.runtime }}

    - name: Setup Node.js (node runtime)
      if: startsWith(matrix.runtime, 'node-')
      uses: actions/setup-node@v4
      with:
        node-version: ${{ steps.version.outputs.value }}
        cache: 'npm'

    - name: Setup Node.js (bun runtime)
      if: startsWith(matrix.runtime, 'bun-')
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: 'npm'

    - name: Setup Bun
      if: startsWith(matrix.runtime, 'bun-')
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ steps.version.outputs.value }}

    - name: Find merge base
      id: merge-base
      run: |
        git fetch origin ${{ github.base_ref }}
        MERGE_BASE=$(git merge-base HEAD origin/${{ github.base_ref }})
        echo "commit=$MERGE_BASE" >> $GITHUB_OUTPUT
        echo "Merge base: $MERGE_BASE"

    - name: Benchmark baseline (merge-base)
      run: |
        echo "Benchmarking merge-base: ${{ steps.merge-base.outputs.commit }}"
        git checkout ${{ steps.merge-base.outputs.commit }}
        npm ci

        # Check if benchmark:json script exists in package.json
        if [ -f package.json ] && grep -q '"benchmark:json"' package.json; then
          echo "Found benchmark:json script, running benchmarks..."
          # Use appropriate runtime for benchmark
          if [[ "${{ matrix.runtime }}" == bun-* ]]; then
            BENCHMARK_CMD="bun run benchmark:json"
          else
            BENCHMARK_CMD="npm run benchmark:json"
          fi

          if timeout 900s $BENCHMARK_CMD baseline-results-${{ matrix.runtime }}.json 2>baseline-error-${{ matrix.runtime }}.log; then
            echo "Baseline benchmark completed successfully"
          else
            echo "Baseline benchmark failed or timed out"
            echo '[]' > baseline-results-${{ matrix.runtime }}.json
          fi
        else
          echo "benchmark:json script not found in merge-base commit, skipping baseline"
          echo "Merge-base does not have benchmark:json script" > baseline-error-${{ matrix.runtime }}.log
          echo '[]' > baseline-results-${{ matrix.runtime }}.json
        fi

    - name: Benchmark PR branch
      run: |
        echo "Benchmarking PR: ${{ github.sha }}"
        git checkout ${{ github.sha }}
        npm ci

        # Use appropriate runtime for benchmark
        if [[ "${{ matrix.runtime }}" == bun-* ]]; then
          BENCHMARK_CMD="bun run benchmark:json"
        else
          BENCHMARK_CMD="npm run benchmark:json"
        fi

        if timeout 900s $BENCHMARK_CMD pr-results-${{ matrix.runtime }}.json 2>pr-error-${{ matrix.runtime }}.log; then
          echo "PR benchmark completed successfully"
        else
          echo "PR benchmark failed or timed out"
          echo '[]' > pr-results-${{ matrix.runtime }}.json
        fi

    - name: Compare results
      id: comparison
      run: |
        # Generate comparison markdown (using Node.js since it's not performance-critical)
        npm run compare-benchmarks baseline-results-${{ matrix.runtime }}.json pr-results-${{ matrix.runtime }}.json > comparison-${{ matrix.runtime }}.md

        # Add runtime version header
        echo "### ${{ matrix.runtime }}" > final-comparison-${{ matrix.runtime }}.md
        echo "" >> final-comparison-${{ matrix.runtime }}.md
        cat comparison-${{ matrix.runtime }}.md >> final-comparison-${{ matrix.runtime }}.md
        echo "" >> final-comparison-${{ matrix.runtime }}.md

    - name: Upload results as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ matrix.runtime }}
        path: |
          baseline-results-${{ matrix.runtime }}.json
          pr-results-${{ matrix.runtime }}.json
          baseline-error-${{ matrix.runtime }}.log
          pr-error-${{ matrix.runtime }}.log
          final-comparison-${{ matrix.runtime }}.md

  # Job to collect all runtime results and post PR comment
  comment:
    runs-on: ubuntu-latest
    needs: benchmark
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history to find merge-base

    - name: Find merge base
      id: merge-base
      run: |
        git fetch origin ${{ github.base_ref }}
        MERGE_BASE=$(git merge-base HEAD origin/${{ github.base_ref }})
        echo "commit=$MERGE_BASE" >> $GITHUB_OUTPUT
        echo "short-commit=${MERGE_BASE:0:7}" >> $GITHUB_OUTPUT
        echo "Merge base: $MERGE_BASE"

    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        path: benchmark-results

    - name: Combine results and post comment
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Combine all runtime results (Node.js and Bun)
        echo "<!-- benchmark-results -->" > combined-results.md
        echo "# üöÄ Benchmark Results" >> combined-results.md
        echo "" >> combined-results.md
        echo "Performance comparison against merge-base [\`${{ steps.merge-base.outputs.short-commit }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.merge-base.outputs.commit }})" >> combined-results.md
        echo "" >> combined-results.md

        # Add results for each runtime (iterate over actual artifacts)
        for result_dir in benchmark-results/benchmark-results-*; do
          if [ -d "$result_dir" ]; then
            # Extract runtime from directory name (benchmark-results-node-22 -> node-22)
            runtime=$(basename "$result_dir" | sed 's/benchmark-results-//')

            if [ -f "$result_dir/final-comparison-${runtime}.md" ]; then
              cat "$result_dir/final-comparison-${runtime}.md" >> combined-results.md
            else
              echo "### ${runtime}" >> combined-results.md
              echo "‚ö†Ô∏è Benchmark failed or timed out" >> combined-results.md
              echo "" >> combined-results.md

              # Add error details if available
              if [ -f "$result_dir/baseline-error-${runtime}.log" ]; then
                echo "<details>" >> combined-results.md
                echo "<summary>Baseline Error Log</summary>" >> combined-results.md
                echo "" >> combined-results.md
                echo "\`\`\`" >> combined-results.md
                head -20 "$result_dir/baseline-error-${runtime}.log" >> combined-results.md
                echo "\`\`\`" >> combined-results.md
                echo "</details>" >> combined-results.md
                echo "" >> combined-results.md
              fi

              if [ -f "$result_dir/pr-error-${runtime}.log" ]; then
                echo "<details>" >> combined-results.md
                echo "<summary>PR Error Log</summary>" >> combined-results.md
                echo "" >> combined-results.md
                echo "\`\`\`" >> combined-results.md
                head -20 "$result_dir/pr-error-${runtime}.log" >> combined-results.md
                echo "\`\`\`" >> combined-results.md
                echo "</details>" >> combined-results.md
                echo "" >> combined-results.md
              fi
            fi
          fi
        done
        
        echo "" >> combined-results.md
        echo "<details>" >> combined-results.md
        echo "<summary>‚ÑπÔ∏è Benchmark Details</summary>" >> combined-results.md
        echo "" >> combined-results.md
        echo "- **Baseline**: Merge-base commit [\`${{ steps.merge-base.outputs.short-commit }}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.merge-base.outputs.commit }}) where this PR branched from ${{ github.base_ref }}" >> combined-results.md
        echo "- **Comparison**: Current PR head [\`${GITHUB_SHA:0:7}\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> combined-results.md
        echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> combined-results.md
        echo "</details>" >> combined-results.md
        
        # Find existing comment or create new one
        COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${{ github.event.number }}/comments" \
          --jq '.[] | select(.body | contains("<!-- benchmark-results -->")) | .id' | head -1)
        
        if [ -n "$COMMENT_ID" ]; then
          echo "Updating existing comment: $COMMENT_ID"
          gh api "repos/${{ github.repository }}/issues/comments/$COMMENT_ID" \
            -X PATCH \
            -f body="$(cat combined-results.md)"
        else
          echo "Creating new comment"
          gh api "repos/${{ github.repository }}/issues/${{ github.event.number }}/comments" \
            -X POST \
            -f body="$(cat combined-results.md)"
        fi

